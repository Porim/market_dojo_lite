<h1>Spend Analysis Report</h1>
<p style="color: #666; margin-bottom: 30px;">Period: <%= @start_date.strftime("%B %d, %Y") %> - <%= @end_date.strftime("%B %d, %Y") %></p>

<div class="grid">
  <div class="grid-item">
    <div class="stat-card">
      <div class="label">Total Spend</div>
      <div class="value">£<%= number_with_delimiter(@spend_by_month.values.sum.round(2)) %></div>
    </div>
  </div>
  <div class="grid-item">
    <div class="stat-card">
      <div class="label">Average Monthly</div>
      <div class="value">£<%= number_with_delimiter((@spend_by_month.values.sum / @spend_by_month.size).round(2)) rescue 0 %></div>
    </div>
  </div>
  <div class="grid-item">
    <div class="stat-card green">
      <div class="label">Total Savings</div>
      <div class="value">£<%= number_with_delimiter(@savings_data.sum { |s| s[:savings_amount] }.round(2)) %></div>
    </div>
  </div>
  <div class="grid-item">
    <div class="stat-card green">
      <div class="label">Avg Savings %</div>
      <div class="value"><%= @savings_data.any? ? (@savings_data.sum { |s| s[:savings_percentage] } / @savings_data.size).round(2) : 0 %>%</div>
    </div>
  </div>
</div>

<h2>Monthly Spend Breakdown</h2>
<table>
  <thead>
    <tr>
      <th>Month</th>
      <th>Total Spend</th>
      <th>Number of RFQs</th>
      <th>Average Quote Value</th>
    </tr>
  </thead>
  <tbody>
    <% @spend_by_month.each do |month, spend| %>
      <% rfq_count = current_user.rfqs.where(created_at: month.beginning_of_month..month.end_of_month).count %>
      <% avg_value = rfq_count > 0 ? spend / rfq_count : 0 %>
      <tr>
        <td><%= month.strftime("%B %Y") %></td>
        <td>£<%= number_with_delimiter(spend.round(2)) %></td>
        <td><%= rfq_count %></td>
        <td>£<%= number_with_delimiter(avg_value.round(2)) %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<h2>Top Categories by Spend</h2>
<% if @top_categories.any? %>
  <table>
    <thead>
      <tr>
        <th>Category</th>
        <th>Total Spend</th>
        <th>% of Total</th>
      </tr>
    </thead>
    <tbody>
      <% total_spend = @top_categories.values.sum %>
      <% @top_categories.each do |category, spend| %>
        <tr>
          <td><%= truncate(category, length: 40) %></td>
          <td>£<%= number_with_delimiter(spend.round(2)) %></td>
          <td><%= ((spend / total_spend) * 100).round(1) %>%</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p style="color: #666;">No category data available for this period.</p>
<% end %>

<div class="page-break"></div>

<h2>Top Savings Opportunities</h2>
<% if @savings_data.any? %>
  <table>
    <thead>
      <tr>
        <th>RFQ Title</th>
        <th>Highest Quote</th>
        <th>Lowest Quote</th>
        <th>Savings Amount</th>
        <th>Savings %</th>
      </tr>
    </thead>
    <tbody>
      <% @savings_data.first(10).each do |saving| %>
        <tr>
          <td><%= truncate(saving[:rfq], length: 30) %></td>
          <td>£<%= number_with_delimiter(saving[:highest_quote].round(2)) %></td>
          <td>£<%= number_with_delimiter(saving[:lowest_quote].round(2)) %></td>
          <td style="color: #059669; font-weight: bold;">£<%= number_with_delimiter(saving[:savings_amount].round(2)) %></td>
          <td><%= saving[:savings_percentage] %>%</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p style="color: #666;">No savings data available for this period.</p>
<% end %>

<h2>Report Summary</h2>
<div class="stat-card" style="margin-top: 30px;">
  <p>This spend analysis report covers the period from <%= @start_date.strftime("%B %d, %Y") %> to <%= @end_date.strftime("%B %d, %Y") %>.</p>
  
  <p style="margin-top: 15px;"><strong>Key Findings:</strong></p>
  <ul style="margin: 10px 0; padding-left: 20px;">
    <li>Total spend of £<%= number_with_delimiter(@spend_by_month.values.sum.round(2)) %> across <%= @spend_by_month.size %> months</li>
    <li>Average monthly spend of £<%= number_with_delimiter((@spend_by_month.values.sum / @spend_by_month.size).round(2)) rescue 0 %></li>
    <li>Identified total savings opportunities of £<%= number_with_delimiter(@savings_data.sum { |s| s[:savings_amount] }.round(2)) %></li>
    <% if @savings_data.any? %>
      <li>Average savings percentage of <%= (@savings_data.sum { |s| s[:savings_percentage] } / @savings_data.size).round(2) %>% across analyzed RFQs</li>
    <% end %>
  </ul>
</div>