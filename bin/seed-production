#!/bin/bash
set -e

echo "ðŸŒ± Seeding production database..."

# This script creates and runs a Cloud Run job to seed the production database
PROJECT_ID="market-dojo-lite-1754153513"
REGION="europe-west2"
SERVICE_NAME="market-dojo-lite"
IMAGE_URL="europe-west2-docker.pkg.dev/${PROJECT_ID}/${SERVICE_NAME}/${SERVICE_NAME}:latest"
JOB_NAME="${SERVICE_NAME}-seed"

# Check if job exists
if gcloud run jobs describe ${JOB_NAME} --region=${REGION} --project=${PROJECT_ID} >/dev/null 2>&1; then
    echo "Seed job already exists, updating it..."
    gcloud run jobs update ${JOB_NAME} \
      --image=${IMAGE_URL} \
      --region=${REGION} \
      --project=${PROJECT_ID} \
      --command="bundle,exec,rails,db:seed" \
      --max-retries=0 \
      --task-timeout=600 \
      --memory=1Gi \
      --cpu=1
else
    echo "Creating new seed job..."
    gcloud run jobs create ${JOB_NAME} \
      --image=${IMAGE_URL} \
      --region=${REGION} \
      --project=${PROJECT_ID} \
      --set-env-vars="RAILS_ENV=production" \
      --set-secrets="DATABASE_URL=database-url:latest,RAILS_MASTER_KEY=rails-master-key:latest,SENTRY_DSN=sentry-dsn:latest" \
      --command="bundle,exec,rails,db:seed" \
      --max-retries=0 \
      --task-timeout=600 \
      --memory=1Gi \
      --cpu=1
fi

# Execute the job
echo "Running seed job..."
gcloud run jobs execute ${JOB_NAME} \
  --region=${REGION} \
  --project=${PROJECT_ID} \
  --wait

echo "âœ… Production database seeded successfully!"